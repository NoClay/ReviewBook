# 枚举根节点

**可达性分析对于时间的敏感性：**可达性分析的过程必须在一个确保一致性的快照中进行--这里“一致性”的意思是指在整个分析的过程中执行系统看起来像是被冻结在某个时间点，不可以出现分析过程中对象的引用关系还在不断变化的情况，这样子分析结果的准确性就无法得到保证。这点是导致GC进行时必须停顿所有执行线程（Stop the world）的一个重要原因，即使是在号称（几乎）不会发生停顿的CMS收集器中，梅菊根结点也是必须要停顿的。

在HotSpot虚拟机中，使用了一组成为OopMap的数据结构来达到这个目的的，在类加载完成的时候，HotSpo就可以将对象内什么偏移量上是什么类型的数据计算出来，在JIT编译过程中，也会在特定的位置记录下战和寄存器中哪些位置是引用。

# 安全点

HotSpot没有为每条指令都生成OopMap，因为这需要大量的内存空间，所以只是在“特定的位置”记录了这些信息，这些位置称为安全点（SafePoint），即程序执行时并非在所有地方都能停顿下来开始GC，只有在到达安全点的时候才能进行暂停。

安全点的选定基本上是以程序“是否具有让程序长时间执行的特征”为标准进行选定的--因为每条指令执行的时间都非常短暂，程序不太可能因为指令流长度太长这个原因而长时间运行，而“长时间执行”最明显的特征就是指令序列服用，例如方法调用、循环跳转、一场跳转等，所以具有这些功能的指令才会产生Safepoint。

## 如何中断

1. **抢先式中断：**不需要线程的执行代码主动的配合，在GC执行的时候，首先把所有线程全部中断，如果发现有线程中断的地方不再安全点上，就恢复线程，让它“跑”到安全点上。
2. **主动式中断：**当GC需要进行中断线程的时候，不直接对线程操作，仅仅简单的设置一个标志，所个线程执行时主动去轮询这个标志，发现中断标志为真时就自己中断挂起，轮询标志的地方和安全点是重合的，另外再加上创建对象的时候需要分配内存的地方。

**几乎没有虚拟机采用抢先式中断！**



